

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DatabankLib.analyze &mdash; NMRlipids Databank v1.3.1.dev5+g764af3ab9 1.3.1.dev5+g764af3ab9 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=32bf1be3"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            NMRlipids Databank v1.3.1.dev5+g764af3ab9
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Python Interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dbprograms.html">DatabankLib CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Project structure</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Membrane Databank</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dbstructure.html">Data Organization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dbcontribute.html">Data Contribution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NMRlipids Databank v1.3.1.dev5+g764af3ab9</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">DatabankLib.analyze</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for DatabankLib.analyze</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">DatabankLib.analyze contains top-level methods for properties&#39; computing.</span>

<span class="sd">Module includes APL, TH, MAICoS, NMRPCA, and OP core analysis functions.</span>
<span class="sd">Code-intensive computations are performed inside corresponding modules.</span>
<span class="sd">Here, we gather only methods exported to the end-user if one wants to start</span>
<span class="sd">recomputing any of Databank&#39;s systems via python interface.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">buildh</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">MDAnalysis</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mda</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">maicos.core.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnalysisCollection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">NMLDB_DATA_PATH</span><span class="p">,</span>
    <span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span>
    <span class="n">RCODE_COMPUTED</span><span class="p">,</span>
    <span class="n">RCODE_ERROR</span><span class="p">,</span>
    <span class="n">RCODE_SKIPPED</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib</span><span class="w"> </span><span class="kn">import</span> <span class="n">analyze_nmrpca</span> <span class="k">as</span> <span class="n">nmrpca</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">System</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.databankio</span><span class="w"> </span><span class="kn">import</span> <span class="n">resolve_download_file_url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.databankLibrary</span><span class="w"> </span><span class="kn">import</span> <span class="n">GetNlipids</span><span class="p">,</span> <span class="n">getLipids</span><span class="p">,</span> <span class="n">system2MDanalysisUniverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.databankop</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_OP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.jsonEncoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompactJSONEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.maicos</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DensityPlanar</span><span class="p">,</span>
    <span class="n">DielectricPlanar</span><span class="p">,</span>
    <span class="n">DiporderPlanar</span><span class="p">,</span>
    <span class="n">FormFactorPlanar</span><span class="p">,</span>
    <span class="n">first_last_carbon</span><span class="p">,</span>
    <span class="n">is_system_suitable_4_maicos</span><span class="p">,</span>
    <span class="n">traj_centering_for_maicos</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">elements</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.settings.engines</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_struc_top_traj_fnames</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">DatabankLib.settings.molecules</span><span class="w"> </span><span class="kn">import</span> <span class="n">lipids_set</span>


<div class="viewcode-block" id="computeNMRPCA">
<a class="viewcode-back" href="../../auto_gen/DatabankLib.analyze.html#DatabankLib.analyze.computeNMRPCA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">computeNMRPCA</span><span class="p">(</span>  <span class="c1"># noqa: N802 (API)</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute eq_times.json using NMR PCA analysis.</span>

<span class="sd">    :param system: System of the Databank</span>
<span class="sd">    :param logger: Logger object</span>
<span class="sd">    :param recompute: Delete previous apl.json and recompute it if True.</span>
<span class="sd">                      Defaults to False.</span>

<span class="sd">    :return: int success code (``RCODE_XXX``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># getting data from databank and preprocessing them</span>
    <span class="c1"># Start Parser</span>
    <span class="c1"># TODO: 2test|    parser = Parser(NMLDB_SIMU_PATH, readme, eq_time_fname, testTraj)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">nmrpca</span><span class="o">.</span><span class="n">Parser</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s2">&quot;eq_times.json&quot;</span><span class="p">)</span>
        <span class="c1"># Check trajectory</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">vpcode</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">validate_path</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ValidatePath code: &quot;</span><span class="p">,</span> <span class="n">vpcode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error initializing NMRPCA parser.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">if</span> <span class="n">vpcode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Some errors in analyze_nmrpca.py::Parser constructor.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">vpcode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;WARNINGS&quot;</span> <span class="ow">in</span> <span class="n">system</span> <span class="ow">and</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;AMBIGUOUS_ATOMNAMES&quot;</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">])</span>
        <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;WARNINGS&quot;</span> <span class="ow">in</span> <span class="n">system</span> <span class="ow">and</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;SKIP_EQTIMES&quot;</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">])</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">RCODE_SKIPPED</span>

    <span class="c1"># Check if TPR is defined and non-null or &quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">__</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;TPR&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;TPR is required for NMRPCA analysis (</span><span class="si">%d</span><span class="s2">})!&quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Download files</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">download_traj</span><span class="p">()</span>
        <span class="c1"># Prepare trajectory</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">prepare_traj</span><span class="p">()</span>
        <span class="c1"># Concatenate trajectory</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">concatenate_traj</span><span class="p">()</span>
        <span class="n">equilibration_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Iterate over trajectories for different lipids</span>
        <span class="k">for</span> <span class="n">lip</span><span class="p">,</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">concatenated_trajs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main: parsing lipid </span><span class="si">{</span><span class="n">lip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Creat PCA for trajectory</span>
            <span class="n">pca_runner</span> <span class="o">=</span> <span class="n">nmrpca</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">traj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">traj</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">traj</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">traj</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parser</span><span class="o">.</span><span class="n">trj_len</span><span class="p">)</span>
            <span class="c1"># Run PCA</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pca_runner</span><span class="o">.</span><span class="n">PCA</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main: PCA: done&quot;</span><span class="p">)</span>
            <span class="c1"># Project trajectory on PC1</span>
            <span class="n">pca_runner</span><span class="o">.</span><span class="n">get_proj</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main: Projections: done&quot;</span><span class="p">)</span>
            <span class="c1"># Calculate autocorrelations</span>
            <span class="n">pca_runner</span><span class="o">.</span><span class="n">get_autocorrelations</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main: Autocorrelations: done&quot;</span><span class="p">)</span>
            <span class="c1"># Estimate equilibration time</span>
            <span class="n">te2</span> <span class="o">=</span> <span class="n">nmrpca</span><span class="o">.</span><span class="n">TimeEstimator</span><span class="p">(</span><span class="n">pca_runner</span><span class="o">.</span><span class="n">autocorrelation</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_time</span><span class="p">()</span>
            <span class="n">equilibration_times</span><span class="p">[</span><span class="n">lip</span><span class="p">]</span> <span class="o">=</span> <span class="n">te2</span> <span class="o">/</span> <span class="n">parser</span><span class="o">.</span><span class="n">trj_len</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main: EQ time: done&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">te2</span> <span class="o">/</span> <span class="n">parser</span><span class="o">.</span><span class="n">trj_len</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">dump_data</span><span class="p">(</span><span class="n">equilibration_times</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Calculation of NMRPCA failed for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RCODE_COMPUTED</span></div>



<div class="viewcode-block" id="computeAPL">
<a class="viewcode-back" href="../../auto_gen/DatabankLib.analyze.html#DatabankLib.analyze.computeAPL">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">computeAPL</span><span class="p">(</span>  <span class="c1"># noqa: N802 (API)</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate apl.json analysis file for a system.</span>

<span class="sd">    Args:</span>
<span class="sd">        system (dict): one of systems of the Databank</span>
<span class="sd">        recompute (bool, optional): Delete previous apl.json and recompute it if True.</span>
<span class="sd">        Defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        int success code (``RCODE_XXX``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: reading software and file path for simulations</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>

    <span class="c1"># this is checking if area per lipid is already calculated for the systems</span>
    <span class="n">outfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;apl.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">recompute</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RCODE_SKIPPED</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analyzing: &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will write into: &quot;</span><span class="p">,</span> <span class="n">outfilename</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># calculates the total number of lipids</span>
        <span class="n">n_lipid</span> <span class="o">=</span> <span class="n">GetNlipids</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

        <span class="c1"># makes MDAnalysis universe from the system. This also downloads the data if not</span>
        <span class="c1"># yet locally available</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">system2MDanalysisUniverse</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generation of MDAnalysis universe failed in folder&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RCODE_ERROR</span>

        <span class="c1"># this calculates the area per lipid as a function of time and stores it</span>
        <span class="c1"># in the databank</span>
        <span class="n">apl</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_ts</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Scanning the trajectory&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;TIMELEFTOUT&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensions</span>
                <span class="n">apl_frame</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">n_lipid</span>
                <span class="n">apl</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">time</span><span class="p">]</span> <span class="o">=</span> <span class="n">apl_frame</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">apl</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">CompactJSONEncoder</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Calculation APL failed for </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RCODE_COMPUTED</span></div>



<div class="viewcode-block" id="computeTH">
<a class="viewcode-back" href="../../auto_gen/DatabankLib.analyze.html#DatabankLib.analyze.computeTH">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">computeTH</span><span class="p">(</span>  <span class="c1"># noqa: N802 (API)</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">thick_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;thickness.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">thick_fn</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RCODE_SKIPPED</span>

    <span class="n">wat_dens_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;WaterDensity.json&quot;</span><span class="p">)</span>
    <span class="n">lip_dens_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;LipidDensity.json&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">lip_dens_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">wat_dens_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">wat_dens</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lip_dens_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lip_dens</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wat_dens</span><span class="p">)</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lip_dens</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">wd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ld</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Dehydrated sample! Standard thickness rule doesn&#39;t work. Will extract boxZ.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="n">wd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wd</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="n">wd</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wd</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">thick_fn</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Calculation TH failed for </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">return</span> <span class="n">RCODE_COMPUTED</span></div>



<span class="c1"># TODO: implement onlyLipid</span>
<div class="viewcode-block" id="computeOP">
<a class="viewcode-back" href="../../auto_gen/DatabankLib.analyze.html#DatabankLib.analyze.computeOP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">computeOP</span><span class="p">(</span>  <span class="c1"># noqa: N802 (API)</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        system (dict): _description_</span>
<span class="sd">        recompute (bool, optional): _description_. Defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        int: _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>

    <span class="c1"># Check if order parameters are calculated or something in the system prevents</span>
    <span class="c1"># order parameter calculation</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;COMPOSITION&quot;</span><span class="p">]:</span>
        <span class="n">outfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;OrderParameters.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s2">&quot;WARNINGS&quot;</span> <span class="ow">in</span> <span class="n">system</span>
            <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="ow">and</span> <span class="s2">&quot;AMBIGUOUS_ATOMNAMES&quot;</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">][</span><span class="s2">&quot;AMBIGUOUS_ATOMNAMES&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">file_found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lipids_set</span><span class="p">:</span>
            <span class="n">file_found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">file_found</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RCODE_SKIPPED</span>

    <span class="c1"># If order parameters are not calculated and system ok, then continue to</span>
    <span class="c1"># calculating order parameters</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analyzing: &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># Download the simulations and create MDAnalysis universe (the universe is not used</span>
    <span class="c1"># here but this script downloads the data)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">system2MDanalysisUniverse</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

    <span class="c1"># Software and time for equilibration period</span>
    <span class="n">software</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">]</span>
    <span class="n">eq_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;TIMELEFTOUT&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="c1"># Check if all or united atom simulation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">united_atom</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;UNITEDATOM_DICT&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">united_atom</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check relevant warnings</span>
    <span class="n">g3switch</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;WARNINGS&quot;</span> <span class="ow">in</span> <span class="n">system</span>
        <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span>
        <span class="ow">and</span> <span class="s2">&quot;GROMACS_VERSION&quot;</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">][</span><span class="s2">&quot;GROMACS_VERSION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gromacs3&quot;</span>
    <span class="p">)</span>

    <span class="n">cur_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">struc_fname</span><span class="p">,</span> <span class="n">top_fname</span><span class="p">,</span> <span class="n">trj_fname</span> <span class="o">=</span> <span class="n">get_struc_top_traj_fnames</span><span class="p">(</span>
            <span class="n">system</span><span class="p">,</span>
            <span class="n">join_path</span><span class="o">=</span><span class="n">cur_path</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error reading filenames from system dictionary.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Set topology file names and make Gromacs trajectories whole</span>
        <span class="k">if</span> <span class="s2">&quot;gromacs&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">top_fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;TPR is required for OP calculations!&quot;</span><span class="p">)</span>
            <span class="n">xtcwhole</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;whole.xtc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xtcwhole</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">echo_proc</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;System</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">g3switch</span><span class="p">:</span>
                        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot;trjconv&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
                            <span class="n">trj_fname</span><span class="p">,</span>
                            <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                            <span class="n">top_fname</span><span class="p">,</span>
                            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
                            <span class="n">xtcwhole</span><span class="p">,</span>
                            <span class="s2">&quot;-pbc&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;mol&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">eq_time</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot;gmx&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;trjconv&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
                            <span class="n">trj_fname</span><span class="p">,</span>
                            <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                            <span class="n">top_fname</span><span class="p">,</span>
                            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
                            <span class="n">xtcwhole</span><span class="p">,</span>
                            <span class="s2">&quot;-pbc&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;mol&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">eq_time</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="k">if</span> <span class="n">united_atom</span> <span class="ow">and</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;TRAJECTORY_SIZE&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">15e9</span><span class="p">:</span>
                        <span class="n">cmd_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-skip&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">echo_proc</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;trjconv exited with error (see above)&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">elif</span> <span class="s2">&quot;openMM&quot;</span> <span class="ow">in</span> <span class="n">software</span> <span class="ow">or</span> <span class="s2">&quot;NAMD&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">struc_fname</span><span class="p">):</span>
                <span class="n">pdb_url</span> <span class="o">=</span> <span class="n">resolve_download_file_url</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOI&quot;</span><span class="p">),</span> <span class="n">struc_fname</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">pdb_url</span><span class="p">,</span> <span class="n">struc_fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Order parameter calculation for other than gromacs, openMM and NAMD are yet to be implemented.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">RCODE_ERROR</span>

        <span class="c1"># Calculate order parameters</span>
        <span class="c1"># -----------------------------------</span>
        <span class="c1"># united-atom switch -&gt; engine switch</span>
        <span class="n">echo_proc</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;System</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">united_atom</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;gromacs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UNITED_ATOMS is supported only for GROMACS engine!&quot;</span><span class="p">)</span>
            <span class="n">frame0struc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;frame0.gro&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">g3switch</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;editconf&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">top_fname</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">frame0struc</span><span class="p">],</span> <span class="nb">input</span><span class="o">=</span><span class="n">echo_proc</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;editconf exited with error (see above)&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g3switch</span><span class="p">:</span>
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                            <span class="p">[</span><span class="s2">&quot;trjconv&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">xtcwhole</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="n">top_fname</span><span class="p">,</span> <span class="s2">&quot;-dump&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">frame0struc</span><span class="p">],</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">echo_proc</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                            <span class="p">[</span><span class="s2">&quot;gmx&quot;</span><span class="p">,</span> <span class="s2">&quot;trjconv&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">xtcwhole</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="n">top_fname</span><span class="p">,</span> <span class="s2">&quot;-dump&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">frame0struc</span><span class="p">],</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">echo_proc</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;trjconv (</span><span class="si">{</span><span class="s1">&#39;trjconv&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">g3switch</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;gmx trjconv&#39;</span><span class="si">}</span><span class="s2">) exited with error (see above)&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;UNITEDATOM_DICT&quot;</span><span class="p">]:</span>
                <span class="c1"># construct order parameter definition file for CH bonds from</span>
                <span class="c1"># mapping file</span>
                <span class="n">mapping_dict</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span>

                <span class="n">def_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.def&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">def_fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">def_file</span><span class="p">:</span>
                    <span class="n">previous_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                    <span class="n">regexp1_H</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;M_[A-Z0-9]*C[0-9]*H[0-9]*_M&quot;</span><span class="p">)</span>  <span class="c1"># noqa: N806</span>
                    <span class="n">regexp2_H</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;M_G[0-9]*H[0-9]*_M&quot;</span><span class="p">)</span>  <span class="c1"># noqa: N806</span>
                    <span class="n">regexp1_C</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;M_[A-Z0-9]*C[0-9]*_M&quot;</span><span class="p">)</span>  <span class="c1"># noqa: N806</span>
                    <span class="n">regexp2_C</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;M_G[0-9]_M&quot;</span><span class="p">)</span>  <span class="c1"># noqa: N806</span>

                    <span class="c1"># Note that mapping_dict&#39;s keys must be ordered</span>
                    <span class="c1"># C11 H111 H112 C12 H121 H122 ...</span>
                    <span class="c1"># otherwize algorithm will fail</span>
                    <span class="k">for</span> <span class="n">mapping_key</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">regexp1_C</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">mapping_key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">regexp2_C</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">mapping_key</span><span class="p">):</span>
                            <span class="n">atom_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping_key</span><span class="p">,</span> <span class="n">mapping_dict</span><span class="p">[</span><span class="n">mapping_key</span><span class="p">][</span><span class="s2">&quot;ATOMNAME&quot;</span><span class="p">]]</span>
                            <span class="n">atom_h</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">elif</span> <span class="n">regexp1_H</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">mapping_key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">regexp2_H</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">mapping_key</span><span class="p">):</span>
                            <span class="n">atom_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping_key</span><span class="p">,</span> <span class="n">mapping_dict</span><span class="p">[</span><span class="n">mapping_key</span><span class="p">][</span><span class="s2">&quot;ATOMNAME&quot;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atom_c</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">atom_h</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">if</span> <span class="n">atom_h</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">atom_c</span>
                            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom_c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atom_h</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">atom_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom_h</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">def_line</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="k">if</span> <span class="n">def_line</span> <span class="o">!=</span> <span class="n">previous_line</span><span class="p">:</span>
                                <span class="n">def_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">def_line</span><span class="p">)</span>
                                <span class="n">previous_line</span> <span class="o">=</span> <span class="n">def_line</span>

                <span class="c1"># Add hydrogens to trajectory and calculate order parameters with buildH</span>
                <span class="n">op_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;OrderParameters.dat&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">lipid_json_file</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">NMLDB_DATA_PATH</span><span class="p">,</span>
                        <span class="s2">&quot;lipid_json_buildH&quot;</span><span class="p">,</span>
                        <span class="n">system</span><span class="p">[</span><span class="s2">&quot;UNITEDATOM_DICT&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">lipid_json_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">lipid_json_file</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;UNITEDATOM_DICT&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
                <span class="n">buildh</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
                    <span class="n">coord_file</span><span class="o">=</span><span class="n">frame0struc</span><span class="p">,</span>
                    <span class="n">def_file</span><span class="o">=</span><span class="n">def_fname</span><span class="p">,</span>
                    <span class="n">lipid_type</span><span class="o">=</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;UNITEDATOM_DICT&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span>
                    <span class="n">lipid_jsons</span><span class="o">=</span><span class="n">lipid_json_file</span><span class="p">,</span>
                    <span class="n">traj_file</span><span class="o">=</span><span class="n">xtcwhole</span><span class="p">,</span>
                    <span class="n">out_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">op_filepath</span><span class="si">}</span><span class="s2">.buildH&quot;</span><span class="p">,</span>
                    <span class="n">ignore_CH3s</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">op_filepath</span> <span class="o">+</span> <span class="s2">&quot;.buildH&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">op_file</span><span class="p">:</span>
                    <span class="n">bh_lines</span> <span class="o">=</span> <span class="n">op_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

                <span class="n">op_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">bh_lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">line2</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
                        <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
                        <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                        <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">op_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>

                    <span class="n">op_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="n">op_values</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]),</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]),</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">]),</span>
                    <span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">op_name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">op_name</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_values</span><span class="p">)</span>

                <span class="c1"># write ascii file (TODO: DO WE NEED IT?)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">op_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Atom     Average OP     OP stem</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">op_lines</span><span class="p">)</span>

                <span class="c1"># write json</span>
                <span class="n">outfile2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;OrderParameters.json&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile2</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">CompactJSONEncoder</span><span class="p">)</span>

        <span class="c1"># not united-atom cases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;gromacs&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
                <span class="n">gro</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;conf.gro&quot;</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Making gro file&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g3switch</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;editconf&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">top_fname</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">gro</span><span class="p">],</span> <span class="nb">input</span><span class="o">=</span><span class="n">echo_proc</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;editconf exited with error (see above)&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                            <span class="p">[</span><span class="s2">&quot;gmx&quot;</span><span class="p">,</span> <span class="s2">&quot;trjconv&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">trj_fname</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="n">top_fname</span><span class="p">,</span> <span class="s2">&quot;-dump&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">gro</span><span class="p">],</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">echo_proc</span><span class="p">,</span>
                            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;trjconv exited with error (see above)&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;COMPOSITION&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;WARNINGS&quot;</span> <span class="ow">in</span> <span class="n">system</span>
                    <span class="ow">and</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="s2">&quot;AMBIGUOUS_ATOMNAMES&quot;</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;WARNINGS&quot;</span><span class="p">][</span><span class="s2">&quot;AMBIGUOUS_ATOMNAMES&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Order parameters cannot be calculated if atom names are ambiguous.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lipids_set</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating &quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot; order parameters&quot;</span><span class="p">)</span>
                    <span class="n">resname</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;COMPOSITION&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;NAME&quot;</span><span class="p">]</span>
                    <span class="n">outfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span>
                        <span class="n">path</span><span class="p">,</span>
                        <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;OrderParameters.dat&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">outfilename2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span>
                        <span class="n">path</span><span class="p">,</span>
                        <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;OrderParameters.json&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfilename2</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Order parameter file already found&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="s2">&quot;gromacs&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">op_obj</span> <span class="o">=</span> <span class="n">find_OP</span><span class="p">(</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span><span class="p">,</span>
                                <span class="n">top_fname</span><span class="p">,</span>
                                <span class="n">xtcwhole</span><span class="p">,</span>
                                <span class="n">resname</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;We got this exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;But we will try rebuild the Universe from GROM if using tpr did not work!&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">op_obj</span> <span class="o">=</span> <span class="n">find_OP</span><span class="p">(</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span><span class="p">,</span>
                                <span class="n">gro</span><span class="p">,</span>
                                <span class="n">xtcwhole</span><span class="p">,</span>
                                <span class="n">resname</span><span class="p">,</span>
                            <span class="p">)</span>

                    <span class="k">if</span> <span class="s2">&quot;openMM&quot;</span> <span class="ow">in</span> <span class="n">software</span> <span class="ow">or</span> <span class="s2">&quot;NAMD&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
                        <span class="n">op_obj</span> <span class="o">=</span> <span class="n">find_OP</span><span class="p">(</span>
                            <span class="n">system</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mapping_dict</span><span class="p">,</span>
                            <span class="n">struc_fname</span><span class="p">,</span>
                            <span class="n">trj_fname</span><span class="p">,</span>
                            <span class="n">resname</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Atom     Average OP     OP stem</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op_obj</span><span class="p">):</span>
                            <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get_avg_std_stem_OP</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">avg</span><span class="si">!s}</span><span class="s2"> </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">stem</span><span class="si">!s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">get_avg_std_stem_OP</span><span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfilename2</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">CompactJSONEncoder</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Order parameters calculated and saved to &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Calculation OP failed for </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">return</span> <span class="n">RCODE_COMPUTED</span></div>



<div class="viewcode-block" id="computeMAICOS">
<a class="viewcode-back" href="../../auto_gen/DatabankLib.analyze.html#DatabankLib.analyze.computeMAICOS">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">computeMAICOS</span><span class="p">(</span>  <span class="c1"># noqa: N802 (API)</span>
    <span class="n">system</span><span class="p">:</span> <span class="n">System</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">ffonly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">recompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_system_suitable_4_maicos</span><span class="p">(</span><span class="n">system</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RCODE_SKIPPED</span>
    <span class="c1"># otherwise continue</span>
    <span class="n">software</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">]</span>
    <span class="c1"># download trajectory and gro files</span>
    <span class="n">system_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOI&quot;</span><span class="p">)</span>
    <span class="n">skip_downloading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">doi</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="k">if</span> <span class="n">skip_downloading</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: The system with &#39;localhost&#39; DOI should be downloaded by the user.&quot;</span><span class="p">)</span>

    <span class="n">set_maicos_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;WaterDensity.json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LipidDensity.json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TotalDensity.json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FormFactor.json&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ffonly</span><span class="p">:</span>
        <span class="n">set_maicos_files</span> <span class="o">|=</span> <span class="p">{</span>
            <span class="s2">&quot;LipidMassDensity.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WaterMassDensity.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TotalMassDensity.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DiporderWater.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Diporder2Water.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TotalChargeDensity.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WaterChargeDensity.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LipidChargeDensity.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DielectricLipid&quot;</span><span class="p">,</span>  <span class="c1"># Dielectric* files are treated</span>
            <span class="s2">&quot;DielectricWater&quot;</span><span class="p">,</span>  <span class="c1"># slightly differently (see below)</span>
            <span class="s2">&quot;DielectricTotal&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;Dielectric&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;_par.json&quot;</span><span class="p">))</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;_perp.json&quot;</span><span class="p">))</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span>
            <span class="p">):</span>
                <span class="n">set_maicos_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">:</span>
            <span class="n">set_maicos_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">struc</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">trj</span> <span class="o">=</span> <span class="n">get_struc_top_traj_fnames</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="n">trj_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">trj</span><span class="p">)</span>
        <span class="n">struc_name</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">struc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">struc</span><span class="p">)</span>
        <span class="n">top_name</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error getting structure/topology/trajectory filenames.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>

    <span class="k">if</span> <span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># No topology =&gt; no charge inforamtion</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dielectric properties and charge densities are not accessible without topology.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;Dielectric&quot;</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s2">&quot;Charge&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">set_maicos_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Diporder&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="c1"># TODO: impute charges!</span>
                <span class="n">set_maicos_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">set_maicos_files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All available MAICoS files are found. Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RCODE_SKIPPED</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Files to be computed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">set_maicos_files</span><span class="p">))</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_not_skip_dwnld</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">skip_downloading</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File [</span><span class="si">{</span><span class="n">trj_name</span><span class="si">}</span><span class="s2">] should be downloaded by user&quot;</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">skip_downloading</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_not_skip_dwnld</span><span class="p">(</span><span class="n">trj_name</span><span class="p">):</span>
            <span class="n">trj_url</span> <span class="o">=</span> <span class="n">resolve_download_file_url</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">trj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">trj_name</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading trajectory with the size of &quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;TRAJECTORY_SIZE&quot;</span><span class="p">],</span> <span class="s2">&quot; to &quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">trj_url</span><span class="p">,</span> <span class="n">trj_name</span><span class="p">)</span>

        <span class="c1"># make a function like this</span>
        <span class="c1"># TODO TPR should not be obligatory for GROMACS</span>
        <span class="k">if</span> <span class="s2">&quot;gromacs&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
            <span class="n">tpr_name</span> <span class="o">=</span> <span class="n">top_name</span>
            <span class="k">if</span> <span class="n">_not_skip_dwnld</span><span class="p">(</span><span class="n">tpr_name</span><span class="p">):</span>
                <span class="n">tpr_url</span> <span class="o">=</span> <span class="n">resolve_download_file_url</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tpr_name</span><span class="p">):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">tpr_url</span><span class="p">,</span> <span class="n">tpr_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;openMM&quot;</span> <span class="ow">in</span> <span class="n">software</span> <span class="ow">or</span> <span class="s2">&quot;NAMD&quot;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_not_skip_dwnld</span><span class="p">(</span><span class="n">struc_name</span><span class="p">):</span>
                <span class="n">pdb_url</span> <span class="o">=</span> <span class="n">resolve_download_file_url</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">struc</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">struc_name</span><span class="p">):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">pdb_url</span><span class="p">,</span> <span class="n">struc_name</span><span class="p">)</span>

        <span class="n">eq_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">system</span><span class="p">[</span><span class="s2">&quot;TIMELEFTOUT&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">last_atom</span><span class="p">,</span> <span class="n">g3_atom</span> <span class="o">=</span> <span class="n">first_last_carbon</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Center around one lipid tail CH3 to guarantee all lipids in the same box</span>
        <span class="k">if</span> <span class="s2">&quot;gromacs&quot;</span> <span class="ow">in</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">]:</span>
            <span class="c1"># xtccentered</span>
            <span class="n">xtccentered</span> <span class="o">=</span> <span class="n">traj_centering_for_maicos</span><span class="p">(</span>
                <span class="n">system_path</span><span class="p">,</span>
                <span class="n">trj_name</span><span class="p">,</span>
                <span class="n">tpr_name</span><span class="p">,</span>
                <span class="n">last_atom</span><span class="p">,</span>
                <span class="n">g3_atom</span><span class="p">,</span>
                <span class="n">eq_time</span><span class="p">,</span>
                <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">tpr_name</span><span class="p">,</span> <span class="n">xtccentered</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Centering for other than Gromacs is currently not implemented.&quot;</span><span class="p">)</span>
            <span class="n">xtccentered</span> <span class="o">=</span> <span class="n">trj_name</span>
            <span class="c1"># it may not work w/o TPR if there are jumps over periodic boundary conditions in z-direction.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">struc_name</span><span class="p">,</span> <span class="n">xtccentered</span><span class="p">)</span>

        <span class="c1"># -- PHILIP code starts here --</span>
        <span class="c1"># We us a hardoced bin width</span>
        <span class="n">bin_width</span> <span class="o">=</span> <span class="mf">0.3</span>

        <span class="c1"># introduce elements attribute (if it&#39;s empty)</span>
        <span class="c1"># and make initial guess (just in case)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">guess_TopologyAttrs</span><span class="p">(</span><span class="n">force_guess</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">])</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">guess_elements</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

        <span class="c1"># Adjust the group selection to be general for analysis</span>
        <span class="n">water</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resname </span><span class="si">{</span><span class="n">system</span><span class="p">[</span><span class="s1">&#39;COMPOSITION&#39;</span><span class="p">][</span><span class="s1">&#39;SOL&#39;</span><span class="p">][</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lipid</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="n">getLipids</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
        <span class="c1"># TODO: Maybe add group for ions and compute densities for them as well?</span>

        <span class="c1"># fixed `zmin` and `zmax` for profiles are deduced from smallest box dimension</span>
        <span class="n">L_min</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># noqa: N806 (PEP8)</span>
        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="p">:</span>
            <span class="n">L_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">L_min</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Skip unwrap/pack for speed - trajectories are already centered and whole</span>
        <span class="n">base_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;unwrap&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;bin_width&quot;</span><span class="p">:</span> <span class="n">bin_width</span><span class="p">,</span> <span class="s2">&quot;pack&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">zlim</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;zmin&quot;</span><span class="p">:</span> <span class="o">-</span><span class="n">L_min</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;zmax&quot;</span><span class="p">:</span> <span class="n">L_min</span> <span class="o">/</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">dens_options</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">zlim</span><span class="p">,</span> <span class="o">**</span><span class="n">base_options</span><span class="p">}</span>

        <span class="n">spath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NMLDB_SIMU_PATH</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>

        <span class="n">request_analysis</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;TotalDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="c1"># Density profiles</span>
            <span class="n">dens_e_total</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;electron&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;TotalDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;TotalDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_e_total</span>

        <span class="k">if</span> <span class="s2">&quot;WaterDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_e_water</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">water</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;electron&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;WaterDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;WaterDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_e_water</span>

        <span class="k">if</span> <span class="s2">&quot;LipidDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_e_lipid</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">lipid</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;electron&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;LipidDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;LipidDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_e_lipid</span>

        <span class="k">if</span> <span class="s2">&quot;TotalMassDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_m_total</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;TotalMassDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;TotalMassDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_m_total</span>

        <span class="k">if</span> <span class="s2">&quot;WaterMassDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_m_water</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">water</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;WaterMassDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;WaterMassDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_m_water</span>

        <span class="k">if</span> <span class="s2">&quot;LipidMassDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_m_lipid</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">lipid</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;LipidMassDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;LipidMassDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_m_lipid</span>

        <span class="k">if</span> <span class="s2">&quot;TotalChargeDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_c_total</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;charge&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;TotalChargeDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;TotalChargeDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_c_total</span>

        <span class="k">if</span> <span class="s2">&quot;WaterChargeDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_c_water</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">water</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;charge&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;WaterChargeDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;WaterChargeDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_c_water</span>

        <span class="k">if</span> <span class="s2">&quot;LipidChargeDensity.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">dens_c_lipid</span> <span class="o">=</span> <span class="n">DensityPlanar</span><span class="p">(</span>
                <span class="n">lipid</span><span class="p">,</span>
                <span class="n">dens</span><span class="o">=</span><span class="s2">&quot;charge&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;LipidChargeDensity.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;LipidChargeDensity.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens_c_lipid</span>

        <span class="c1"># Form factor</span>
        <span class="c1"># Use `None` for `zmin`/`zmax` to respect changing cell size (vs fixed</span>
        <span class="c1"># zmin/zmax for density profiles)</span>
        <span class="k">if</span> <span class="s2">&quot;FormFactor.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">form_factor</span> <span class="o">=</span> <span class="n">FormFactorPlanar</span><span class="p">(</span>
                <span class="n">atomgroup</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="o">**</span><span class="n">base_options</span><span class="p">,</span>
                <span class="n">zmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">zmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;FormFactor.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;FormFactor.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form_factor</span>

        <span class="c1"># Water Orientation</span>
        <span class="c1"># TODO: Maybe also compute orientation for lipid heads/tails?</span>
        <span class="k">if</span> <span class="s2">&quot;DiporderWater.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">cos_water</span> <span class="o">=</span> <span class="n">DiporderPlanar</span><span class="p">(</span>
                <span class="n">water</span><span class="p">,</span>
                <span class="n">order_parameter</span><span class="o">=</span><span class="s2">&quot;cos_theta&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;DiporderWater.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;DiporderWater.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_water</span>

        <span class="k">if</span> <span class="s2">&quot;Diporder2Water.json&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">cos2_water</span> <span class="o">=</span> <span class="n">DiporderPlanar</span><span class="p">(</span>
                <span class="n">water</span><span class="p">,</span>
                <span class="n">order_parameter</span><span class="o">=</span><span class="s2">&quot;cos_2_theta&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">dens_options</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;Diporder2Water.json&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;Diporder2Water.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos2_water</span>

        <span class="c1"># Dielectric profiles</span>
        <span class="k">if</span> <span class="s2">&quot;DielectricTotal&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">diel_total</span> <span class="o">=</span> <span class="n">DielectricPlanar</span><span class="p">(</span>
                <span class="n">u</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="o">**</span><span class="n">base_options</span><span class="p">,</span>
                <span class="n">output_prefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;DielectricTotal&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;DielectricTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diel_total</span>

        <span class="k">if</span> <span class="s2">&quot;DielectricWater&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">diel_water</span> <span class="o">=</span> <span class="n">DielectricPlanar</span><span class="p">(</span>
                <span class="n">water</span><span class="p">,</span>
                <span class="o">**</span><span class="n">base_options</span><span class="p">,</span>
                <span class="n">output_prefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;DielectricWater&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;DielectricWater&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diel_water</span>

        <span class="k">if</span> <span class="s2">&quot;DielectricLipid&quot;</span> <span class="ow">in</span> <span class="n">set_maicos_files</span><span class="p">:</span>
            <span class="n">diel_lipid</span> <span class="o">=</span> <span class="n">DielectricPlanar</span><span class="p">(</span>
                <span class="n">lipid</span><span class="p">,</span>
                <span class="o">**</span><span class="n">base_options</span><span class="p">,</span>
                <span class="n">output_prefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="s2">&quot;DielectricLipid&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">request_analysis</span><span class="p">[</span><span class="s2">&quot;DielectricLipid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diel_lipid</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We are ready to recompute </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request_analysis</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="p">{</span><span class="s2">&quot;DielectricLipid&quot;</span><span class="p">,</span> <span class="s2">&quot;DielectricWater&quot;</span><span class="p">,</span> <span class="s2">&quot;DielectricTotal&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">request_analysis</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check if dielectric profiles can be calculated (not possible for charged systems)&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">diel_total</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dielectric profiles not available for this system: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># create stub json-s to avoid recompute tries</span>
                <span class="k">for</span> <span class="n">dfile</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DielectricTotal&quot;</span><span class="p">,</span> <span class="s2">&quot;DielectricWater&quot;</span><span class="p">,</span> <span class="s2">&quot;DielectricLipid&quot;</span><span class="p">]:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">dfile</span> <span class="o">+</span> <span class="s2">&quot;_per.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_path</span><span class="p">,</span> <span class="n">dfile</span> <span class="o">+</span> <span class="s2">&quot;_par.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created empty dielectric profile JSONs for </span><span class="si">{</span><span class="n">dfile</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DielectricTotal&quot;</span><span class="p">,</span> <span class="s2">&quot;DielectricWater&quot;</span><span class="p">,</span> <span class="s2">&quot;DielectricLipid&quot;</span><span class="p">]:</span>
                    <span class="n">request_analysis</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request_analysis</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">AnalysisCollection</span><span class="p">(</span><span class="o">*</span><span class="n">request_analysis</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">collection</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="n">request_analysis</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">analysis</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># finall catch</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Calculation MAICOS failed for </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">system</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">RCODE_ERROR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RCODE_COMPUTED</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NMRlipids Open Collaboration
    OSI Approved: GNU General Public License v3 (GPLv3)
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version
   .
        <p>
            <a href="https://github.com/NMRLipids/Databank/blob/main/LICENSE.txt"
            target="_blank"
            rel="noopener">
            Link to GNU GPL v3 License
            </a>
        </p>
        <p>
            <a href="https://github.com/NMRLipids/Databank"
            target="_blank"
            rel="noopener">
            Link to the GitHub repository
            </a>
        </p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>