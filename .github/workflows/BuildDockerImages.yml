name: Build Docker Images
on:
  schedule:
    - cron: "0 4 1 * *"
  
  workflow_dispatch:

jobs:
  build_gromacs_and_core:
    runs-on: ubuntu-latest
    if: github.repository == 'NMRLipids/Databank'
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Get latest gromacs release version 
        id: version
        run: |
            set -euo pipefail
            tag="$(curl -fsSL "https://gitlab.com/api/v4/projects/gromacs%2Fgromacs/releases/permalink/latest" | jq -r .tag_name)"
            echo "version=${tag#v}" >> "$GITHUB_OUTPUT"
            echo "Latest tag: $tag" 
        
      - name: Checkout Databank repo
        uses: actions/checkout@v4

      - name: Build gromacs image
        run: |
          docker build \
            -f Scripts/Docker/gromacs \
            -t nmrlipids/gromacs \
            --build-arg GROMACS_VERSION=${{ steps.version.outputs.version }} \
            .
      - name: Push gromacs image
        run: |
          docker push nmrlipids/gromacs

      - name: Build core image
        run: |
          docker build -f Scripts/Docker/core -t nmrlipids/core .

      - name: Push core image
        run: docker push nmrlipids/core

  build_doc_builder:
     runs-on: ubuntu-latest
     if: github.repository == 'NMRLipids/Databank'
     steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          
      - name: Checkout Databank repo 
        uses: actions/checkout@v4

      - name: Build doc-builder image
        run: |
          docker build -f Scripts/Docker/doc-builder -t nmrlipids/doc-builder .

      - name: Push doc-builder image
        run: docker push nmrlipids/doc-builder
