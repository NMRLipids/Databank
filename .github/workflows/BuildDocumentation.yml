name: Build documentation

on: 
  workflow_dispatch: #Can be triggered manually. 

  push:
    branches: 
      - main #Will run with changes to main branch (including merged pull requests)
    paths:
      - Scripts/**  #Will only run with changes within the Scripts folder (including subfolders)
    
jobs:
    build-documentation:
        runs-on: ubuntu-latest
        container:
           image: nmrlipids/doc-builder 
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
               ref: "clean_document_cicd"
          
          - name: Update dependencies   #Checks for updates in package requirements. 
            run: pip install --break-system-packages -e .

          - name: generate rst files 
            run: sphinx-apidoc -f -o auto_gen --separate --implicit-namespaces -d 1 --templatedir _templates/apidoc ../..
            working-directory: Scripts/BuildDocs/source
       
          - name: build
            run: make html
            working-directory: Scripts/BuildDocs

          - name: Archive production artifacts  #This step will upload the documentation files as an artifact 
            uses: actions/upload-artifact@v4
            with:
                name: html-build
                path: Scripts/BuildDocs/build/html/*
                retention-days: 1
        
    deploy-documentation:
        runs-on: ubuntu-latest
        needs: build-documentation
        steps:
            - name: checkout
              uses: actions/checkout@v4
              with:
                repository: "MagnusPriv/NMRLipids.github.io"
                ref: "push_test"   
                token: ${{ secrets.DOCUMENT_TOKEN }}   

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                name: html-build
                path: .
                
            - name: Commit and push documentation
              uses: EndBug/add-and-commit@v9
              with:
                author_name: github-actions[bot]
                author_email: github-actions[bot]@users.noreply.github.com
                message: "Automated update of documentation"
                    
            




